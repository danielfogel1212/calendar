<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> 砖 注  砖专 驻 住驻</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f7f7f7;
            color: #333;
            margin: 0;
            padding: 20px;
            text-align: center;
        }

        h1 {
            color: #4CAF50;
            margin-bottom: 20px;
            font-size: 2.5em;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .branch-select, .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .branch-select select, .calendar-nav button {
            font-size: 1.1em;
            padding: 10px 15px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        .calendar-nav button {
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
        }

        .calendar-nav button:hover {
            background-color: #45a049;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 15px;
            text-align: center;
            border: 1px solid #ddd;
        }

        th {
            background-color: #4CAF50;
            color: white;
        }

        td {
            background-color: #f9f9f9;
            position: relative;
            color: #333;
        }

        .day .date {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .birthday, .event, .holiday {
            font-size: 0.9em;
            margin-top: 5px;
            padding: 5px;
            border-radius: 4px;
            text-align: center;
        }

        .birthday {
           
            color: #333;
        }

        .holiday {
            background-color: #FFA500;
            color: white;
        }

        .event {
            padding: 5px;
            border-radius: 4px;
            color: white;
        }

        /* Color styles for different branches */
        .branch-1 {
            background-color: #FF6347;
            color: white;
        }

        .branch-2 {
            background-color: #4682B4;
            color: white;
        }

        .branch-3 {
            background-color: #32CD32;
            color: white;
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 2em;
            }

            .calendar-nav button, .branch-select select {
                font-size: 1em;
                padding: 8px 12px;
            }

            th, td {
                padding: 10px;
            }
        }
        #branchLegend span {
    display: inline-block;
    padding: 5px 10px;
    margin-right: 10px;
    border-radius: 4px;
    font-weight: bold;
    color: white;
}

.branch-1 {
    background-color: #FF6347; /* 爪注  */
}

.branch-2 {
    background-color: #4682B4; /* 爪注  */
}

.branch-3 {
    background-color: #32CD32; /* 爪注 专拽 */
}

    </style>
</head>
<body style="direction: rtl;">
    <div class="container">
        <h1> 砖 注  砖专</h1>

        <div id="branchLegend" style="text-align: right; margin-bottom: 20px;">
            <span class="branch-1"> 转 </span> |
            <span class="branch-2"> 专 砖注</span> |
            <span class="branch-3"> 专砖</span>
        </div>
        
        <div class="branch-select">
            <label for="branchSelect">专 住祝:</label>
            <select id="branchSelect" name="branchSelect">
                <!-- Branch options will be populated dynamically -->
            </select>
        </div>
        <div class="calendar-nav">
            <button id="prev-month">砖 拽</button>
            <span id="current-month"></span>
            <button id="next-month">砖 </button>
        </div>
        <table id="calendar">
            <thead>
                <tr>
                    <th>'</th>
                    <th>'</th>
                    <th>'</th>
                    <th>'</th>
                    <th>'</th>
                    <th>'</th>
                    <th>砖'</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

    <script>
        const monthNames = [
            '专', '驻专专', '专抓', '驻专', '', '',
            '', '住', '住驻专', '拽专', '专', '爪专'
        ];

        // Branch color mapping
        const branchColors = {
            1: '#FF6347',  // Example branch ID 1 with red
            4: '#4682B4',  // Example branch ID 2 with blue
            6: '#32CD32',  // Example branch ID 3 with green
        };

        document.addEventListener('DOMContentLoaded', () => {
            const calendarContainer = document.querySelector('#calendar tbody');
            const currentMonthElement = document.getElementById('current-month');
            const prevMonthButton = document.getElementById('prev-month');
            const nextMonthButton = document.getElementById('next-month');
            const branchSelect = document.getElementById('branchSelect');

            let currentYear = new Date().getFullYear();
            let currentMonth = new Date().getMonth();
            let selectedBranch = 'all';

            // Fetch and populate branches
            fetchBranches();

            prevMonthButton.addEventListener('click', () => {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                updateCalendar(currentYear, currentMonth, selectedBranch);
            });

            nextMonthButton.addEventListener('click', () => {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                updateCalendar(currentYear, currentMonth, selectedBranch);
            });

            branchSelect.addEventListener('change', (event) => {
                selectedBranch = event.target.value;
                updateCalendar(currentYear, currentMonth, selectedBranch);
            });

            updateCalendar(currentYear, currentMonth, selectedBranch);

            setInterval(() => {
                updateCalendar(currentYear, currentMonth, selectedBranch);
            }, 30000);
        });

        async function fetchBranches() {
            try {
                const response = await fetch('http://127.0.0.1:5000/branches');
                if (response.ok) {
                    const branches = await response.json();
                    populateBranchSelect(branches);
                } else {
                    console.error('Error fetching branches:', response.statusText);
                }
            } catch (error) {
                console.error('Error fetching branches:', error);
            }
        }

        function populateBranchSelect(branches) {
            const branchSelect = document.getElementById('branchSelect');
            branchSelect.innerHTML = '';

            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = ' 住驻';
            branchSelect.appendChild(allOption);

            branches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch.id;
                option.textContent = branch.city;
                branchSelect.appendChild(option);
            });
        }

        async function updateCalendar(year, month, branchId) {
            const birthdayData = await birthdays(branchId);
            const eventData = await events(branchId);
            const holidayData = await fetchHolidays(year, month + 1);

            const calendarContainer = document.querySelector('#calendar tbody');
            const currentMonthElement = document.getElementById('current-month');
            calendarContainer.innerHTML = '';
            currentMonthElement.textContent = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let row = document.createElement('tr');

            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('td');
                row.appendChild(emptyCell);
            }

            const birthdayMap = mapBirthdays(birthdayData, month);
            const eventMap = mapEvents(eventData, year, month);
            const holidayMap = mapHolidays(holidayData);

            for (let day = 1; day <= daysInMonth; day++) {
                if (row.children.length === 7) {
                    calendarContainer.appendChild(row);
                    row = document.createElement('tr');
                }

                const dayCell = document.createElement('td');
                dayCell.className = 'day';

                const dateDiv = document.createElement('div');
                dateDiv.className = 'date';
                dateDiv.textContent = day;
                dayCell.prepend(dateDiv);  // Make sure the date is always at the top

                if (holidayMap[day]) {
                    const holidayDiv = document.createElement('div');
                    holidayDiv.className = 'holiday';
                    holidayDiv.textContent = holidayMap[day];
                    dayCell.appendChild(holidayDiv);
                    dayCell.classList.add('holiday');
                }

                if (birthdayMap[day]) {
                    birthdayMap[day].forEach(name=> {
                        const birthdayDiv = document.createElement('div');
                        birthdayDiv.className = 'birthday';
                        birthdayDiv.style.backgroundColor=branchColors[name.branch.id];
                        birthdayDiv.textContent = `${name.name} `;
                     
                        dayCell.appendChild(birthdayDiv);
                    });
                    dayCell.classList.add('birthday');
                }

                if (eventMap[day]) {
                    eventMap[day].forEach(event => {
                        const eventDiv = document.createElement('div');
                        eventDiv.className = 'event';
                        eventDiv.style.backgroundColor = branchColors[event.branch.id] || '#ccc';
                        eventDiv.textContent = `${day}/${month + 1} - ${event.event_description} `;
                        dayCell.appendChild(eventDiv);
                    });
                    dayCell.classList.add('event');
                }

                row.appendChild(dayCell);
            }

            while (row.children.length < 7) {
                const emptyCell = document.createElement('td');
                row.appendChild(emptyCell);
            }

            calendarContainer.appendChild(row);
        }

        function mapBirthdays(birthdays, month) {
            const birthdayMap = {};
            birthdays.forEach(birthday => {
                const [monthPart, dayPart] = birthday.date.split('-');
                if (parseInt(monthPart) - 1 === month) {
                    const day = parseInt(dayPart);
                    if (!birthdayMap[day]) {
                        birthdayMap[day] = [];
                    }
                    birthdayMap[day].push(birthday);
                }
            });
            return birthdayMap;
        }

        function mapEvents(events, year, month) {
            const eventMap = {};
            events.forEach(event => {
                const eventDate = new Date(event.date);
                if (eventDate.getFullYear() === year && eventDate.getMonth() === month) {
                    const day = eventDate.getDate();
                    if (!eventMap[day]) {
                        eventMap[day] = [];
                    }
                    eventMap[day].push(event);
                }
            });
            return eventMap;
        }

        function mapHolidays(holidays) {
            const holidayMap = {};
            holidays.forEach(holiday => {
                const holidayDate = new Date(holiday.date).getDate();
                holidayMap[holidayDate] = holiday.title;
            });
            return holidayMap;
        }

        async function birthdays(branchId) {
    const token = getToken();
    if (!token) {
        console.error('No token found. Please login again.');
        return [];  // Optionally, you can redirect the user to the login page
    }

    let url = 'http://127.0.0.1:5000/birthdays';
    if (branchId && branchId !== 'all') {
        url += `?branch_id=${branchId}`;
    }

    try {
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'  // Added content-type header for consistency
            }
        });

        if (response.ok) {
            const data = await response.json();
            return data;  // Return the fetched birthday data
        } else {
            // Handle different HTTP status codes
            console.error('Error fetching birthdays:', response.status, response.statusText);
            if (response.status === 401) {
                alert('Unauthorized access. Please log in again.');
                // Optionally, log out the user or redirect to login page
            }
            return [];
        }
    } catch (error) {
        console.error('Error fetching birthdays:', error);
        return [];
    }
}

        async function events(branchId) {
            const token = getToken();
            if (!token) {
                console.error('No token found');
                return [];
            }

            let url = 'http://127.0.0.1:5000/events';
            if (branchId && branchId !== 'all') {
                url += `?branch_id=${branchId}`;
            }

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (response.ok) {
                    return await response.json();
                } else {
                    console.error('Error fetching events:', response.statusText);
                    return [];
                }
            } catch (error) {
                console.error('Error fetching events:', error);
                return [];
            }
        }

        async function fetchHolidays(year, month) {
            try {
                const response = await fetch(`https://www.hebcal.com/hebcal?v=1&cfg=json&maj=on&year=${year}&month=${month}&lg=h`);
                if (response.ok) {
                    const data = await response.json();
                    return data.items || [];
                } else {
                    console.error('Error fetching holidays:', response.statusText);
                    return [];
                }
            } catch (error) {
                console.error('Error fetching holidays:', error);
                return [];
            }
        }

        function getToken() {
            return localStorage.getItem('access_token');
        }
    </script> 

</body>
</html>
